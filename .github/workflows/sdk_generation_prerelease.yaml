name: Generate RC SDK (Prerelease)
permissions:
  checks: write
  contents: write
  pull-requests: write
  statuses: write

on:
  workflow_dispatch: {}
  pull_request:
    types: [labeled, unlabeled]

jobs:
  check-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure workflow is run from openapi-prerelease branch
        run: |
          if [[ "${GITHUB_REF_NAME}" != "openapi-prerelease" ]]; then
            echo "This workflow can only be run from the openapi-prerelease branch."
            exit 1
          fi

  compute-version:
    needs: check-branch
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - name: Checkout openapi-prerelease
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: openapi-prerelease
          fetch-depth: 0


      - name: Compute prerelease version (X.Y.Zrc<n>)
        id: ver
        run: |
          set -euo pipefail

          # Fetch tags (add --refs to avoid peeled ^{} entries)
          git fetch --tags --quiet || true

          # DEBUG: show last tags
          echo "Last tags on origin:"
          git ls-remote --tags --refs origin | awk '{print $2}' | sed 's|refs/tags/||' | tail -n 50 || true

          # Find the latest official (non-rc) version tag
          # Extract all version tags (with or without 'v' prefix), exclude rc tags, sort semver-style
          # Use awk to pad version numbers for proper numeric sorting
          LATEST_OFFICIAL=$(git ls-remote --tags --refs origin | awk '{print $2}' | sed 's|refs/tags/||' | sed 's|^v||' \
            | { grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' || true; } \
            | awk -F. '{printf "%03d.%03d.%03d %s\n", $1, $2, $3, $0}' | sort -r | head -n 1 | awk '{print $2}' || true)

          if [[ -z "${LATEST_OFFICIAL}" ]]; then
            echo "Error: No official version tags found. Cannot compute prerelease version."
            exit 1
          fi

          echo "Latest official version: ${LATEST_OFFICIAL}"

          # Bump minor version (X.Y.Z -> X.(Y+1).0)
          IFS='.' read -r major minor _ <<< "${LATEST_OFFICIAL}"
          minor=$((minor + 1))
          BASE="${major}.${minor}.0"

          echo "Bumped minor version to: ${BASE}"

          PREFIX="${BASE}rc"

          # Helper to check tag existence with/without 'v' (use --refs; no sed with \^\{\})
          tag_exists() {
            git ls-remote --tags --refs origin | awk '{print $2}' | sed 's|refs/tags/||' \
              | grep -qx -e "${1}" -e "v${1}"
          }

          # Find next available rc number (with logging)
          n=1
          while tag_exists "${PREFIX}${n}"; do
            echo "Tag already exists: ${PREFIX}${n} (or v${PREFIX}${n}), trying next..."
            n=$((n+1))
          done

          echo "First free rc tag: ${PREFIX}${n}"
          FINAL="${PREFIX}${n}"
          echo "Computed prerelease (Python format): ${FINAL}"
          echo "version=${FINAL}" >> "$GITHUB_OUTPUT"

  generate:
    needs: [check-branch, compute-version]
    uses: speakeasy-api/sdk-generation-action/.github/workflows/workflow-executor.yaml@5b268931ef6902bbb70fa01b467dc361c68f7617
    with:
      force: true
      mode: pr
      set_version: ${{ needs.compute-version.outputs.version }}
    secrets:
      github_access_token: ${{ secrets.GITHUB_TOKEN }}
      pypi_token: ${{ secrets.PYPI_TOKEN }}
      speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}
